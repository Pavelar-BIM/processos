<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>P. AVELAR - HUB</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    
    <style>
        :root { --primary: #002B49; --accent: #F26522; --sidebar-w: 300px; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
        
        /* Estilo da tela de Login */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 9999; color: white;
        }
        .login-box { 
            background: white; 
            padding: 40px; 
            border-radius: 8px; 
            text-align: center; 
            color: #333; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .login-logo {
            width: 200px;
            height: auto;
            margin-bottom: 25px;
        }
        .error-msg { color: #d9534f; margin-top: 15px; font-weight: bold; display: none; max-width: 300px; font-size: 0.8rem; }

        /* Esconde o app por padrão */
        #app-container { display: none; height: 100vh; width: 100%; }
        
        body { background: #f5f5f5; height: 100vh; overflow: hidden; }
        #sidebar { width: var(--sidebar-w); background: var(--primary); color: white; display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; transition: all 0.3s; }
        #sidebar.hide { margin-left: calc(var(--sidebar-w) * -1); }
        .sidebar-header { padding: 25px; background: #001f35; text-align: center; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .menu-section { border-bottom: 1px solid rgba(255,255,255,0.05); }
        .menu-title { padding: 15px 20px; cursor: pointer; background: rgba(0,0,0,0.2); font-size: 0.8rem; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .menu-items { list-style: none; display: none; }
        .menu-items.open { display: block; }
        .menu-items li { padding: 10px 15px 10px 20px; color: #b0c4de; cursor: pointer; font-size: 0.85rem; transition: 0.2s; }
        .menu-items li:hover { background: rgba(255,255,255,0.05); color: white; border-left: 4px solid var(--accent); }
        .submenu { list-style: none; display: none; padding-left: 15px; margin-top: 5px; border-left: 1px solid rgba(255,255,255,0.2); }
        .submenu.open { display: block; }
        .has-sub { font-weight: 600; color: white !important; }
        .has-sub span::after { content: ' ▼'; font-size: 0.6rem; opacity: 0.5; }
        .has-sub.active-sub span::after { content: ' ▲'; }
        #main-content { flex: 1; display: flex; flex-direction: column; background: #f5f5f5; overflow: hidden; }
        .top-bar { height: 60px; background: white; border-bottom: 1px solid #eee; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; flex-shrink: 0; }
        iframe { width: 100%; height: 100%; border: none; }
        .welcome-msg { display: flex; flex: 1; align-items: center; justify-content: center; font-weight: 600; color: var(--primary); }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <img src="assets/img/logo-pavelar.png" alt="P. Avelar Logo" class="login-logo">
            
            <h2 style="margin-bottom: 10px;">Acesso Restrito</h2>
            <p style="margin-bottom: 20px; color: #666;">Use seu e-mail de trabalho</p>
            <div id="buttonDiv"></div>
            <div id="error-msg" class="error-msg">Acesso negado.</div>
        </div>
    </div>

    <div id="app-container">
        <aside id="sidebar">
            <div class="sidebar-header">P. AVELAR <br><small>HUB DE PROCESSOS</small></div>
            <div id="menu-container"></div>
        </aside>

        <main id="main-content">
            <div class="top-bar">
                <button onclick="document.getElementById('sidebar').classList.toggle('hide')" style="cursor:pointer; background:none; border:none; font-size:1.5rem;">☰</button>
                <button onclick="logout()" style="cursor:pointer; background:#eee; border:none; padding:5px 10px; border-radius:4px; font-size:0.7rem; font-weight:bold;">Sair</button>
            </div>
            <div id="content-area" style="flex: 1; display: flex; overflow: hidden;">
                <iframe name="content-frame" id="content-frame" src="about:blank" style="display: none;"></iframe>
                <div id="placeholder-msg" class="welcome-msg">Utilize o menu lateral</div>
            </div>
        </main>
    </div>

    <script src="assets/js/links.js"></script>

    <script>
        const GOOGLE_CLIENT_ID = "553016551832-jh7e40elbvelhl2db7tnkdn2sfb2jkld.apps.googleusercontent.com";

        function handleCredentialResponse(response) {
            try {
                const data = jwt_decode(response.credential);
                const email = data.email.toLowerCase().trim();
                
                if (email.endsWith("@pavelarengenharia.com.br")) {
                    localStorage.setItem("pavelar_auth", "true");
                    localStorage.setItem("pavelar_auth_time", new Date().getTime());
                    showApp();
                } else {
                    const errorDiv = document.getElementById("error-msg");
                    errorDiv.style.display = "block";
                    errorDiv.innerText = "Acesso negado para: " + email;
                }
            } catch (err) {
                console.error("Erro na decodificação:", err);
            }
        }

        function showApp() {
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("app-container").style.display = "flex";
            if(typeof renderMenu === "function") renderMenu();
            if(typeof checkHash === "function") checkHash();
        }

        function logout() {
            localStorage.removeItem("pavelar_auth");
            localStorage.removeItem("pavelar_auth_time");
            window.location.reload();
        }

        window.onload = function () {
            const isAuthorized = localStorage.getItem("pavelar_auth");
            const lastLogin = localStorage.getItem("pavelar_auth_time");
            const now = new Date().getTime();
            const directAccess = 24 * 60 * 60 * 1000; // 24 horas

            if (isAuthorized === "true" && lastLogin && (now - lastLogin < directAccess)) {
                showApp();
            } else {
                localStorage.removeItem("pavelar_auth");
                localStorage.removeItem("pavelar_auth_time");
                
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleCredentialResponse
                });
                google.accounts.id.renderButton(
                    document.getElementById("buttonDiv"),
                    { theme: "outline", size: "large", text: "signin_with" }
                );
            }
        };

        // Funções de controle do Iframe e Hash
        function loadPage(url) {
            if (!url || url.startsWith('#')) return;
            const frame = document.getElementById('content-frame');
            const msg = document.getElementById('placeholder-msg');
            frame.style.display = 'block';
            msg.style.display = 'none';
            frame.src = url;
            const pageName = url.split('/').pop().replace('.html', '');
            window.location.hash = pageName;
        }

        function checkHash() {
            const hash = window.location.hash.replace('#', '');
            if (hash) { loadPage(`pages/${hash}.html`); }
        }

        function createMenuItem(item) {
            const li = document.createElement('li');
            if (item.subitens && item.subitens.length > 0) {
                const textNode = document.createElement('span');
                textNode.innerText = item.nome;
                li.appendChild(textNode);
                li.className = 'has-sub';
                const subUl = document.createElement('ul');
                subUl.className = 'submenu';
                item.subitens.forEach(sub => subUl.appendChild(createMenuItem(sub)));
                li.onclick = (e) => {
                    e.stopPropagation();
                    subUl.classList.toggle('open');
                    li.classList.toggle('active-sub');
                };
                li.appendChild(subUl);
            } else {
                li.innerText = item.nome;
                li.onclick = (e) => {
                    e.stopPropagation();
                    loadPage(item.link);
                };
            }
            return li;
        }

        function renderMenu() {
            const container = document.getElementById('menu-container');
            if (!container || !window.CONFIG) return;
            container.innerHTML = '';
            window.CONFIG.menus.forEach(grupo => {
                const section = document.createElement('div');
                section.className = 'menu-section';
                const title = document.createElement('div');
                title.className = 'menu-title';
                title.innerHTML = `${grupo.titulo} <span class="arrow">▼</span>`;
                const ul = document.createElement('ul');
                ul.className = 'menu-items';
                title.onclick = () => {
                    const isOpen = ul.classList.contains('open');
                    ul.classList.toggle('open');
                    title.querySelector('.arrow').innerText = isOpen ? '▼' : '▲';
                };
                grupo.itens.forEach(item => ul.appendChild(createMenuItem(item)));
                section.appendChild(title);
                section.appendChild(ul);
                container.appendChild(section);
            });
        }
    </script>
</body>
</html>
