<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Processos - BPMN</title>
    
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js/dist/assets/diagram-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js/dist/assets/bpmn-font/css/bpmn.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #002B49; 
            --accent: #F26522; 
            --link-blue: #007bff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
        body, html { height: 100%; overflow: hidden; background: #f5f5f5; }
        
        /* Barra de Ferramentas */
        .controls-bar {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.95);
            padding: 0 25px;
            height: 45px; 
            min-width: 280px; 
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #ddd;
        }

        .btn-back {
            background: var(--primary);
            color: white;
            border: none;
            height: 28px;
            padding: 0 15px;
            border-radius: 14px;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 700;
            display: none; 
            transition: background 0.2s;
            white-space: nowrap;
        }
        .btn-back:hover { background: var(--accent); }

        .zoom-info {
            font-size: 0.7rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            white-space: nowrap;
        }

        #canvas { width: 100%; height: 100vh; background: #fff; }

        /* Estilização dos nós que possuem links */
        .highlight-link .djs-visual > rect, 
        .highlight-link .djs-visual > circle, 
        .highlight-link .djs-visual > polygon {
            stroke: var(--link-blue) !important;
            stroke-width: 2px !important;
            fill: rgba(0, 123, 255, 0.05) !important;
        }
        
        .highlight-node .djs-visual > :first-child { 
            fill: rgba(242, 101, 34, 0.1) !important; 
            stroke: var(--accent) !important; 
            stroke-width: 3px !important; 
            cursor: pointer !important; 
        }

        .bjs-powered-by { display: none; }
    </style>
</head>
<body>

    <div class="controls-bar">
        <button id="backButton" class="btn-back" onclick="goBack()">← VOLTAR</button>
        <div class="zoom-info">Ctrl + Scroll para Zoom</div>
    </div>

    <div id="canvas"></div>

    <script src="https://unpkg.com/bpmn-js/dist/bpmn-navigated-viewer.development.js"></script>
    
    <script src="assets/js/filepaths.js" onerror="console.warn('filepaths.js não encontrado')"></script>

    <script>
        // Inicializa o visualizador com navegação (pan e zoom)
        const bpmnViewer = new BpmnJS({ container: '#canvas' });
        let historyStack = [];

        // CAMINHO CORRIGIDO: Relativo à pasta onde o HTML está
        const INITIAL_DIAGRAM = 'assets/bpmn/arq-modelagem-familias.bpmn';

        async function loadDiagram(url, isBack = false) {
            if (!url) return;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Erro ao buscar arquivo: ${response.statusText}`);
                
                const xml = await response.text();
                await bpmnViewer.importXML(xml);
                
                // Gerenciamento de histórico para o botão "Voltar"
                if (!isBack) {
                    if (historyStack.length === 0 || historyStack[historyStack.length - 1] !== url) {
                        historyStack.push(url);
                    }
                }
                
                updateBackButton();
                
                // Ajusta o diagrama à tela
                const canvas = bpmnViewer.get('canvas');
                canvas.zoom('fit-viewport');

                // Aplica estilos se a função getAsset existir no filepaths.js
                applyStylesIfAvailable();
                
            } catch (err) {
                console.error('Erro ao carregar o BPMN:', err);
                // Tenta carregar com um nível acima caso o HTML esteja em uma pasta 'pages' ou similar
                if (!url.startsWith('../') && !isBack) {
                    console.log('Tentando caminho alternativo...');
                    loadDiagram('../' + url, false);
                }
            }
        }

        function applyStylesIfAvailable() {
            if (typeof getAsset !== 'function') return;
            
            const canvas = bpmnViewer.get('canvas');
            const elementRegistry = bpmnViewer.get('elementRegistry');
            
            elementRegistry.forEach(element => {
                const name = element.businessObject.name;
                if (name && (getAsset(name, "BPMN") || getAsset(name, "DOCS"))) {
                    canvas.addMarker(element.id, 'highlight-link');
                }
            });
        }

        function updateBackButton() {
            const btn = document.getElementById('backButton');
            btn.style.display = historyStack.length > 1 ? 'block' : 'none';
        }

        function goBack() {
            if (historyStack.length > 1) {
                historyStack.pop(); // Remove o atual
                const previous = historyStack[historyStack.length - 1];
                loadDiagram(previous, true);
            }
        }

        // Eventos de Clique
        bpmnViewer.get('eventBus').on('element.click', (e) => {
            if (typeof getAsset !== 'function') return;
            
            const name = e.element.businessObject.name;
            if (!name) return;

            const bpmnPath = getAsset(name, "BPMN");
            if (bpmnPath) loadDiagram(bpmnPath);
            
            const docPath = getAsset(name, "DOCS");
            if (docPath) window.open(docPath, '_blank');
        });

        // Evento de Hover
        bpmnViewer.get('eventBus').on('element.hover', (e) => {
            if (typeof getAsset === 'function') {
                const name = e.element.businessObject.name;
                if (name && (getAsset(name, "BPMN") || getAsset(name, "DOCS"))) {
                    bpmnViewer.get('canvas').addMarker(e.element.id, 'highlight-node');
                }
            }
        });

        // Carrega o diagrama ao iniciar
        window.onload = () => {
            loadDiagram(INITIAL_DIAGRAM);
        };
    </script>
</body>
</html>