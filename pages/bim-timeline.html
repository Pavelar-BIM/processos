<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano de implementaÃ§Ã£o BIM - P. AVELAR</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    
    <style>
        :root { 
            --primary-color: #002B49; 
            --accent-color: #F26522; 
            --bg-light: #f8f9fa; 
            --text-dark: #333;
            --status-blue: #2563eb;
            --status-green: #22c55e;
        }

        body { font-family: 'Montserrat', sans-serif; background-color: white; color: var(--text-dark); margin: 0; padding: 40px 10px; }
        .container { max-width: 1250px; margin: 0 auto; }
        .header h1 { color: var(--primary-color); border-bottom: 3px solid var(--accent-color); padding-bottom: 10px; font-weight: 700; margin-bottom: 10px; }
        
        .controls { display: flex; gap: 10px; margin-bottom: 30px; align-items: center; flex-wrap: wrap; }
        .btn-export { background-color: #2e7d32; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.8rem; }
        .status-msg { font-size: 0.85rem; color: #666; font-style: italic; }

        .timeline { position: relative; padding: 20px 0; }
        .timeline::before { content: ''; position: absolute; left: 31px; top: 0; bottom: 0; width: 4px; background: var(--primary-color); border-radius: 2px; }

        .item-container { position: relative; margin-bottom: 10px; }
        .level-0 { padding-left: 85px; margin-bottom: 25px; }
        
        .level-0 > .marker { 
            position: absolute; left: 10px; top: 0; width: 46px; height: 46px; 
            background: var(--primary-color); border: 4px solid white; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            color: white; font-weight: 700; z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
        }

        .card { 
            background: white; border-radius: 6px; padding: 8px 15px; border: 1px solid #eee; 
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); transition: 0.2s; 
        }
        .card:hover { border-color: var(--accent-color); }

        .title-area { display: flex; align-items: center; flex: 1; min-width: 0; cursor: pointer; }
        .title { font-weight: 500; font-size: 0.85rem; color: var(--text-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .level-0 .title { font-weight: 700; font-size: 1rem; color: var(--primary-color); }
        
        .editable-meta { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }
        .edit-input, .edit-select { 
            border: 1px solid #ddd; padding: 4px 6px; border-radius: 4px; 
            font-family: 'Montserrat'; font-size: 0.7rem; color: #555;
            background-color: #fff;
        }
        
        .resp-field { width: 160px; }
        .dur-field { width: 45px; }
        .status-field { width: 130px; font-weight: 700; text-transform: uppercase; }

        .status-andamento { background-color: var(--status-blue) !important; color: white !important; }
        .status-finalizado { background-color: var(--status-green) !important; color: white !important; }

        .children { margin-left: 12px; display: none; border-left: 1px solid #e2e8f0; padding-left: 8px; margin-top: 5px; }
        .expanded > .children { display: block; }
        .toggle-icon { color: var(--accent-color); font-size: 0.6rem; margin-right: 8px; flex-shrink: 0; }
        .no-children .toggle-icon { visibility: hidden; }

        /* Overlay de carregamento igual ao seu outro arquivo */
        #loading-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999; display: none;
        }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <p style="font-weight:600; color:#002B49;">PROCESSANDO PLANILHA...</p>
</div>

<div class="container">
    <div class="header">
        <h1>Plano de implementaÃ§Ã£o BIM (PIB)</h1>
    </div>

    <div class="controls">
        <button class="btn-export" onclick="exportToExcel()">ðŸ’¾ Salvar Planilha Atualizada</button>
        <span id="load_status" class="status-msg">Iniciando...</span>
    </div>

    <div id="timeline_container" class="timeline"></div>
</div>

<script>
    let currentWorkbook = null;
    let responsaveisList = [
        "BIM manager", "Lider instalaÃ§Ãµes", "Lider Arquitetura", "Lider Apoio", 
        "Lider OrÃ§amento", "Lider Estrutural", "Lider Geral", "Lider RH", 
        "Planejamento", "Diretor de engenharia", "Sistema", "Processos", 
        "Arquiteto", "Engenheiro - Estrutura", "Engenheiro - Eletrica", 
        "Engenheiro - Hidro", "EstagiÃ¡rio"
    ];

    const EXCEL_PATH = '../assets/excel/BIM-TIMELINE.xlsx';

    window.addEventListener('DOMContentLoaded', loadExcelFromServer);

    async function loadExcelFromServer() {
        document.getElementById('loading-overlay').style.display = 'flex';
        try {
            const response = await fetch(EXCEL_PATH);
            if (!response.ok) throw new Error("Arquivo nÃ£o encontrado.");
            
            const arrayBuffer = await response.arrayBuffer();
            currentWorkbook = new ExcelJS.Workbook();
            await currentWorkbook.xlsx.load(arrayBuffer);
            
            const sheet = currentWorkbook.worksheets[0];
            const rows = [];
            
            // Converte as linhas do ExcelJS para o formato de array que o renderTimeline usa
            sheet.eachRow({ includeEmpty: true }, (row, rowNumber) => {
                const rowData = [];
                for(let i = 1; i <= 15; i++) {
                    const cell = row.getCell(i);
                    rowData[i-1] = cell.value;
                }
                rows[rowNumber-1] = rowData;
            });

            renderTimeline(rows);
            document.getElementById('load_status').innerText = "Arquivo BIM-TIMELINE.xlsx carregado.";
        } catch (err) {
            console.error(err);
            document.getElementById('load_status').innerText = "Erro ao carregar planilha.";
        } finally {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    }

    function getStatusClass(status) {
        const s = status ? status.toString().toLowerCase() : "";
        if (s.includes('andamento')) return 'status-andamento';
        if (s.includes('finalizado')) return 'status-finalizado';
        return '';
    }

    function getResponsavelOptions(selected) {
        return responsaveisList.map(name => 
            `<option value="${name}" ${selected === name ? 'selected' : ''}>${name}</option>`
        ).join('');
    }

    function renderTimeline(rows) {
        const container = document.getElementById('timeline_container');
        container.innerHTML = '';
        let stack = { '-1': container }; 
        let mainCounter = 0;

        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (!row || row.length === 0) continue;

            let content = "";
            let level = -1;
            // Busca o conteÃºdo nas colunas 0 a 7
            for (let colIdx = 0; colIdx <= 7; colIdx++) {
                if (row[colIdx]) { content = row[colIdx]; level = colIdx; break; }
            }
            if (level === -1) continue;

            const itemDiv = document.createElement('div');
            itemDiv.className = `item-container level-${level} no-children`;
            
            const resp = row[9] || '';
            const dur = row[10] || '0';
            const status = row[12] || 'A iniciar';

            let markerHtml = level === 0 ? `<div class="marker">${++mainCounter}</div>` : "";

            itemDiv.innerHTML = `
                ${markerHtml}
                <div class="card">
                    <div class="title-area" onclick="toggleItem(this)">
                        <span class="toggle-icon">â–¶</span>
                        <span class="title" title="${content}">${content}</span>
                    </div>
                    <div class="editable-meta">
                        <select class="edit-select resp-field" onchange="updateRow(${i}, 9, this.value)">
                            <option value="">Selecione...</option>
                            ${getResponsavelOptions(resp)}
                        </select>
                        <input type="number" class="edit-input dur-field" value="${dur}" onchange="updateRow(${i}, 10, this.value)">
                        <select class="edit-select status-field ${getStatusClass(status)}" onchange="updateStatus(this, ${i})">
                            <option value="A iniciar" ${status === 'A iniciar' ? 'selected' : ''}>A INICIAR</option>
                            <option value="Em andamento" ${status === 'Em andamento' ? 'selected' : ''}>ANDAMENTO</option>
                            <option value="Finalizado" ${status === 'Finalizado' ? 'selected' : ''}>FINALIZADO</option>
                        </select>
                    </div>
                </div>
                <div class="children"></div>
            `;

            const parent = stack[level - 1];
            if (level === 0) container.appendChild(itemDiv);
            else if (parent) {
                parent.classList.remove('no-children');
                parent.querySelector('.children').appendChild(itemDiv);
            }

            stack[level] = itemDiv;
            for (let l = level + 1; l <= 7; l++) delete stack[l];
        }
    }

    function toggleItem(el) {
        el.closest('.item-container').classList.toggle('expanded');
    }

    function updateRow(rowIndex, colIndex, value) {
        const sheet = currentWorkbook.worksheets[0];
        // ExcelJS usa base 1 para linhas e colunas
        sheet.getRow(rowIndex + 1).getCell(colIndex + 1).value = value;
    }

    function updateStatus(selectEl, rowIndex) {
        const val = selectEl.value;
        updateRow(rowIndex, 12, val);
        selectEl.classList.remove('status-andamento', 'status-finalizado');
        const newClass = getStatusClass(val);
        if (newClass) selectEl.classList.add(newClass);
    }

    async function exportToExcel() {
        document.getElementById('loading-overlay').style.display = 'flex';
        try {
            const buffer = await currentWorkbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'BIM_TIMELINE_ATUALIZADO.xlsx';
            a.click();
        } catch (err) {
            console.error(err);
            alert("Erro ao exportar o arquivo.");
        } finally {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    }
</script>
</body>
</html>
